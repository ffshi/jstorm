<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : User Defined Log, Switch log4j/logback, Use user's log configuration</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance_cn">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/quickstart_cn/BasicConception.html">5分钟基础概念(新手第一篇)</a></li>
                
                <li class=""><a href="/quickstart_cn/Example.html">入门Example</a></li>
                
                <li class=""><a href="/quickstart_cn/Deploy/">安装部署</a></li>
                
                <li class=""><a href="/quickstart_cn/Upgrade/">升级</a></li>
                
                <li class=""><a href="/quickstart_cn/UpgradeFromStorm.html">从Apache Storm升级到JStorm</a></li>
                
                <li class=""><a href="/quickstart_cn/Compile.html">编译JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide_cn/DebugLocalApp.html">本地调试</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/StreamSplitJoin.html">数据流分流合并</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Transaction/">事务</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Trident/">Trident</a></li>
                  
                  <li class="active"><a href="/ProgrammingGuide_cn/AdvancedUsage/">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">运维 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance_cn/Configuration.html">配置注解</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ConfigurationAutomacticSync.html">自动同步配置文件</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/Isolation.html">资源隔离</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/HealthCheck.html">Supervisor自检</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ClusterHA.html">同城灾备&异地灾备</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/BlobStore.html">BlobStore</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/DynamicAdjustLog.html">动态调整日志</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ_cn/">FAQ</a></li>



            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">社区 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
            <li class="hidden-sm "><a href="http://storm.taobao.org">Demo</a></li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/" class="active">Advanced Usage</a>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/API.html" class="">API介绍</a>
          
          <ul>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/API/Grouping.html" class="">Grouping 介绍</a></li>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/API/IBasicBolt.html" class="">IBasicBolt 介绍</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/Theory.html" class="">Theory</a>
          
          <ul>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/Theory/Acker.html" class="">Acker 原理</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/Plugins.html" class="">Plugins</a>
          
          <ul>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/Plugins/Flux.html" class="">Flux 插件</a></li>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/Plugins/Hdfs.html" class="">HDFS 插件</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/UserDefined.html" class="">User-Defined-API</a>
          
          <ul>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/UserDefined/Alarm.html" class="">自定义报错</a></li>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/UserDefined/Log.html" class="active">自定义日志</a></li>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/UserDefined/Metrics.html" class="">自定义监控</a></li>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/UserDefined/Scheduler.html" class="">自定义调度</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/DynamicAdjust.html" class="">动态变更</a>
          
          <ul>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/DynamicAdjust/Configuration.html" class="">动态更新配置</a></li>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/DynamicAdjust/Metrics.html" class="">动态调整Metrics</a></li>
            
              <li><a href="/ProgrammingGuide_cn/AdvancedUsage/DynamicAdjust/Parallel.html" class="">动态调整并发</a></li>
            
          </ul>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/SQL.html" class="">SQL-on-JStorm</a>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/SubmitTopology.html" class="">API 提交任务</a>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/BackPressure.html" class="">限流控制/反压</a>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/Window.html" class="">Window Framework</a>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/PerformanceTuning.html" class="">性能优化</a>
          
        </li>
      
        
        <li><a href="/ProgrammingGuide_cn/AdvancedUsage/BlobStore.html" class="">BlobStore</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <div class="text">
      <!-- Main heading -->
      <h1>User Defined Log, Switch log4j/logback, Use user's log configuration</h1>

      <!-- Content -->
      <ul id="markdown-toc">
  <li><a href="#log4j" id="markdown-toc-log4j">强烈建议使用Log4j</a></li>
  <li><a href="#log4j-1" id="markdown-toc-log4j-1">使用自定义Log4j的配置文件</a></li>
  <li><a href="#logback" id="markdown-toc-logback">使用logback</a>    <ul>
      <li><a href="#logbacklog4j" id="markdown-toc-logbacklog4j">只使用logback，不使用log4j</a></li>
      <li><a href="#log4jlogback" id="markdown-toc-log4jlogback">同时使用Log4j和Logback。</a></li>
    </ul>
  </li>
</ul>

<p>本文档将告诉JStorm使用者，如何自定义日志</p>

<h2 id="log4j">强烈建议使用Log4j</h2>
<p>在jstorm中，底层强制使用log4j，在jstorm 0.9.0 release时， jstorm升级到logback，但遭遇大量日志兼容性问题，需要应用修改代码。因此在jstorm 0.9.1 后，回退到log4j， 其实jstorm是鼓励用户使用log4j，而不是logback， 因为log4j的兼容性远远好于logback，一个应用需要依赖大量的二方包，这些二方包使用各种日志系统和日志框架，千变万化，但有一点肯定会支持log4j，但不一定支持logback，另外虽然logback的性能要优于log4j，但有什么系统会一天打印几十G的文件呢，因此logback并不能带来应用性能的提升，却带来大量兼容性问题。
所以在使用过程中， 强烈建议使用Log4j</p>

<h2 id="log4j-1">使用自定义Log4j的配置文件</h2>
<p>在早期jstorm 版本中，发现大量应用hack的日志系统，并且使用千奇百怪的日志配置文件，遭遇了大量问题，后来从jstorm 0.9.2 后，强制log4j使用jstorm的log4j配置文件，避免了很多问题，但也带来了一些问题。用户不能自定义日志。用户有一个特殊的日志需求时，基本很难满足。
从0.9.6.3 开始，提供自定义日志功能。</p>

<p>使用配置项
<code>
user.defined.log4j.conf: xxxxxxxxxxxxxxxxxxxxx
</code><code>
或者
</code><code>
ConfigExtension.setUserDefinedLog4jConf((Map conf, String fileName))
</code>`</p>

<p>举例1：
<code>
user.defined.log4j.conf: user.log4j.properties
</code>
此时配置文件user.log4j.properties必须在classpath中，因此，需要打包在用户的jar中</p>

<p>举例2
<code>
user.defined.log4j.conf: “File:/home/admin/jstorm/conf/user.log4j.properties”
</code>
此时配置文件就是一个明确绝对路径的文件</p>

<p>当打开classloader时， 因为应用jar 不在默认classpath中， 所以必须使用绝对路径方式，类似下面
<code>
user.defined.log4j.conf: “File:/home/admin/jstorm/conf/user.log4j.properties”
</code></p>

<h2 id="logback">使用logback</h2>
<p>因为有些应用，把多个进程的日志打到一个文件中去，log4j无法完成该功能，会强制使用logback</p>

<h3 id="logbacklog4j">只使用logback，不使用log4j</h3>
<p>先介绍一下log4j和logback背景知识， 在java世界里， 日志框架通常有log4j 和slf4j， 而日志实现常用有log4j和logback， 
通常情况下：
<code>
log4j -- &gt; log4j
slf4j --&gt; logback
</code>
如果应用需要log4j的代码能被logback打印，则需要log4j-over-slf4j桥接器， 同样，如果想sl4j的代码能被log4j打印，则需要sl4j-log4j桥接器
<code>
log4j --&gt; log4j-over-sl4j --&gt; logback
slf4j --&gt; slf4j-log4j      --&gt; log4j
</code>
但log4j-over-sl4j 和slf4j-log4j 是2个相互冲突的jar，不允许在同一个classloader内部。</p>

<p>当只使用logback时，maven需要把所有的slf4j-log4j12排除掉
```
    <dependency>
    		<groupId>com.alibaba.jstorm</groupId>
			<artifactId>jstorm-client-extension</artifactId>
			<version>${jstorm.version}</version>
			<scope>provided</scope>
		</dependency></p>

<pre><code>	&lt;dependency&gt;
		&lt;groupId&gt;com.alibaba.jstorm&lt;/groupId&gt;
		&lt;artifactId&gt;jstorm-client&lt;/artifactId&gt;
		&lt;version&gt;${jstorm.version}&lt;/version&gt;
		&lt;scope&gt;provided&lt;/scope&gt;
		&lt;exclusions&gt;
			&lt;exclusion&gt;
				&lt;groupId&gt;org.slf4j&lt;/groupId&gt;
				&lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
			&lt;/exclusion&gt;
		&lt;/exclusions&gt;
	&lt;/dependency&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;com.alibaba.jstorm&lt;/groupId&gt;
		&lt;artifactId&gt;jstorm-server&lt;/artifactId&gt;
		&lt;version&gt;${jstorm.version}&lt;/version&gt;
		&lt;scope&gt;provided&lt;/scope&gt;

	&lt;/dependency&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
		&lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
		&lt;version&gt;1.0.13&lt;/version&gt;
	&lt;/dependency&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;org.slf4j&lt;/groupId&gt;
		&lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
		&lt;version&gt;1.7.10&lt;/version&gt;
	&lt;/dependency&gt; ```
</code></pre>

<p>另外在配置文件中，需要设置
<code>
user.defined.logback.conf: xxxxxxxxxxxxxxxx
</code>
或使用
<code>
ConfigExtension.setUserDefinedLogbackConf(Map conf, String fileName)
</code>
xxxxxxxxxxxx可以是一个绝对路径文件， 也可以是一个在classpath路径， 另外jstorm内部提供jstorm_home变量， 比如“%JSTORM_HOME%/conf/cluster.xml”</p>

<h3 id="log4jlogback">同时使用Log4j和Logback。</h3>
<p>如果想同时使用log4j和logback， 则需要打开classloader。
1. 所有用log4j的代码，最终都会用log4j打印，无论是jstorm的打印还是应用的打印
2. 应用使用slf4j的代码，最终会用logback打印</p>

<p>另外注意， log4j和logback不要把日志打到同一个文件上，否则，当rolling时，会有日志丢失问题。</p>

<p>此种情况下，maven的pom.xml 不需要特别设置，不过，建议还是把所有的slf4j-log4j12排除掉</p>

<pre><code>topology.enable.classloader: true
user.defined.logback.conf: xxxxxxxxxxxxxxxx
</code></pre>

<p>更多请阅读: http://gitlab.alibaba-inc.com/aloha/jstorm-guide/wikis/Migrate-To-JStorm-Merge#3</p>
      
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
